--// Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local player = Players.LocalPlayer
local camera = Workspace.CurrentCamera

--// Settings
local espEnabled = true
local lockEnabled = false
local lockDistance = 150
local highlightList = {}
local currentTarget = nil

--// GUI
local gui = Instance.new("ScreenGui", player:WaitForChild("PlayerGui"))
gui.ResetOnSpawn = false

local menuFrame = Instance.new("Frame", gui)
menuFrame.Size = UDim2.new(0, 200, 0, 180)
menuFrame.Position = UDim2.new(0.05, 0, 0.6, 0)
menuFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
menuFrame.BorderSizePixel = 2
menuFrame.BorderColor3 = Color3.fromRGB(0, 255, 0)
menuFrame.Active = true
menuFrame.Draggable = true

local toggleButton = Instance.new("TextButton", menuFrame)
toggleButton.Size = UDim2.new(1, 0, 0, 30)
toggleButton.Text = "❌ ปิดเมนู"
toggleButton.TextScaled = true
toggleButton.BackgroundColor3 = Color3.fromRGB(0, 170, 0)
toggleButton.TextColor3 = Color3.new(1, 1, 1)

local contentFrame = Instance.new("Frame", menuFrame)
contentFrame.Size = UDim2.new(1, 0, 1, -30)
contentFrame.Position = UDim2.new(0, 0, 0, 30)
contentFrame.BackgroundTransparency = 1
contentFrame.ClipsDescendants = true

-- ESP ปุ่ม
local espButton = Instance.new("TextButton", contentFrame)
espButton.Size = UDim2.new(1, -20, 0, 40)
espButton.Position = UDim2.new(0, 10, 0, 10)
espButton.Text = "ESP: เปิด"
espButton.BackgroundColor3 = Color3.fromRGB(0, 150, 0)
espButton.TextScaled = true
espButton.TextColor3 = Color3.new(1, 1, 1)

-- Lock ปุ่ม
local lockButton = Instance.new("TextButton", contentFrame)
lockButton.Size = UDim2.new(1, -20, 0, 40)
lockButton.Position = UDim2.new(0, 10, 0, 60)
lockButton.Text = "ล็อคเป้า: ปิด"
lockButton.BackgroundColor3 = Color3.fromRGB(150, 0, 0)
lockButton.TextScaled = true
lockButton.TextColor3 = Color3.new(1, 1, 1)

-- ระยะล็อค
local rangeBox = Instance.new("TextBox", contentFrame)
rangeBox.Size = UDim2.new(1, -20, 0, 30)
rangeBox.Position = UDim2.new(0, 10, 0, 110)
rangeBox.PlaceholderText = "ระยะล็อค (150)"
rangeBox.Text = tostring(lockDistance)
rangeBox.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
rangeBox.TextColor3 = Color3.new(1, 1, 1)
rangeBox.TextScaled = true

-- พับเมนู
local menuOpen = true
toggleButton.MouseButton1Click:Connect(function()
	menuOpen = not menuOpen
	if menuOpen then
		contentFrame.Visible = true
		toggleButton.Text = "❌ ปิดเมนู"
	else
		contentFrame.Visible = false
		toggleButton.Text = "✔️ เปิดเมนู"
	end
end)

-- ปุ่ม ESP
espButton.MouseButton1Click:Connect(function()
	espEnabled = not espEnabled
	if espEnabled then
		espButton.Text = "ESP: เปิด"
		espButton.BackgroundColor3 = Color3.fromRGB(0, 150, 0)
	else
		espButton.Text = "ESP: ปิด"
		espButton.BackgroundColor3 = Color3.fromRGB(150, 0, 0)
		for _, hl in pairs(highlightList) do
			if hl and hl.Parent then hl:Destroy() end
		end
		highlightList = {}
	end
end)

-- ปุ่มล็อคเป้า
lockButton.MouseButton1Click:Connect(function()
	lockEnabled = not lockEnabled
	if lockEnabled then
		lockButton.Text = "ล็อคเป้า: เปิด"
		lockButton.BackgroundColor3 = Color3.fromRGB(0, 150, 0)
	else
		lockButton.Text = "ล็อคเป้า: ปิด"
		lockButton.BackgroundColor3 = Color3.fromRGB(150, 0, 0)
	end
end)

-- กล่องระยะ
rangeBox.FocusLost:Connect(function()
	local n = tonumber(rangeBox.Text)
	if n and n > 0 then
		lockDistance = n
	else
		rangeBox.Text = tostring(lockDistance)
	end
end)

-- ตรวจเพื่อน/ศัตรู
local function isEnemy(plr)
	if not plr or plr == player then return false end
	if plr.Team and player.Team and plr.Team == player.Team then return false end
	if plr.TeamColor and player.TeamColor and plr.TeamColor == player.TeamColor then return false end
	return true
end

-- สร้าง ESP
local function createESP(character, color)
	if not character:FindFirstChild("HumanoidRootPart") then return end
	if highlightList[character] then return end
	local hl = Instance.new("Highlight")
	hl.FillColor = color
	hl.OutlineColor = color
	hl.Parent = character
	highlightList[character] = hl
end

local function cleanupESP()
	for char, hl in pairs(highlightList) do
		if not char or not char.Parent then
			if hl and hl.Parent then hl:Destroy() end
			highlightList[char] = nil
		end
	end
end

-- อัปเดต ESP ทุก 1 วินาที
task.spawn(function()
	while true do
		if espEnabled then
			for _, plr in pairs(Players:GetPlayers()) do
				if plr ~= player and plr.Character then
					if isEnemy(plr) then
						createESP(plr.Character, Color3.fromRGB(255, 0, 0))
					else
						createESP(plr.Character, Color3.fromRGB(0, 255, 0))
					end
				end
			end
			cleanupESP()
		end
		task.wait(1)
	end
end)

-- หาศัตรูที่กล้องมองเห็นจริง
local function getVisibleEnemy()
	local closest, dist = nil, lockDistance
	for _, plr in pairs(Players:GetPlayers()) do
		if isEnemy(plr) and plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") then
			local hrp = plr.Character.HumanoidRootPart
			local mag = (hrp.Position - camera.CFrame.Position).Magnitude
			if mag <= dist then
				local params = RaycastParams.new()
				params.FilterType = Enum.RaycastFilterType.Blacklist
				params.FilterDescendantsInstances = {player.Character}
				local result = Workspace:Raycast(camera.CFrame.Position, (hrp.Position - camera.CFrame.Position).Unit * mag, params)
				if result and result.Instance and result.Instance:IsDescendantOf(plr.Character) then
					dist = mag
					closest = plr
				end
			end
		end
	end
	return closest
end

-- หมุนกล้องล็อคเป้า (เวอร์ชันมือถือ Smooth)
RunService.RenderStepped:Connect(function()
	if lockEnabled then
		local target = getVisibleEnemy()
		if target and target.Character and target.Character:FindFirstChild("HumanoidRootPart") then
			currentTarget = target
			local pos = target.Character.HumanoidRootPart.Position
			camera.CFrame = camera.CFrame:Lerp(CFrame.new(camera.CFrame.Position, pos), 0.15)
		end
	end
end)
