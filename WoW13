--// Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Workspace = game:GetService("Workspace")

local player = Players.LocalPlayer
local camera = Workspace.CurrentCamera

--// Settings
local espEnabled = true
local lockTargetEnabled = false
local lockRange = 100 -- ‡∏£‡∏∞‡∏¢‡∏∞‡∏•‡πá‡∏≠‡∏Ñ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
local highlightList = {}
local currentTarget = nil

--// GUI
local gui = Instance.new("ScreenGui", player:WaitForChild("PlayerGui"))
gui.ResetOnSpawn = false

--// Menu Frame
local menuFrame = Instance.new("Frame", gui)
menuFrame.Size = UDim2.new(0, 220, 0, 180)
menuFrame.Position = UDim2.new(0.05, 0, 0.5, 0)
menuFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
menuFrame.BorderSizePixel = 2
menuFrame.Active = true
menuFrame.Draggable = true

local uiCorner = Instance.new("UICorner", menuFrame)
uiCorner.CornerRadius = UDim.new(0, 10)

--// Title Bar
local title = Instance.new("TextButton", menuFrame)
title.Size = UDim2.new(1, 0, 0, 30)
title.Text = "üéØ ESP & Lock Menu (‡∏û‡∏±‡∏ö‡πÑ‡∏î‡πâ)"
title.BackgroundColor3 = Color3.fromRGB(255, 0, 0)
title.TextColor3 = Color3.new(1, 1, 1)
title.TextScaled = true

local isFolded = false
title.MouseButton1Click:Connect(function()
	isFolded = not isFolded
	for _, obj in pairs(menuFrame:GetChildren()) do
		if obj ~= title and obj:IsA("GuiObject") then
			obj.Visible = not isFolded
		end
	end
	menuFrame.Size = isFolded and UDim2.new(0, 220, 0, 30) or UDim2.new(0, 220, 0, 180)
end)

--// ESP Button
local espButton = Instance.new("TextButton", menuFrame)
espButton.Size = UDim2.new(1, -20, 0, 40)
espButton.Position = UDim2.new(0, 10, 0, 40)
espButton.Text = "ESP: ‡πÄ‡∏õ‡∏¥‡∏î"
espButton.BackgroundColor3 = Color3.fromRGB(0, 150, 0)
espButton.TextColor3 = Color3.new(1, 1, 1)
espButton.TextScaled = true

espButton.MouseButton1Click:Connect(function()
	espEnabled = not espEnabled
	if espEnabled then
		espButton.Text = "ESP: ‡πÄ‡∏õ‡∏¥‡∏î"
		espButton.BackgroundColor3 = Color3.fromRGB(0, 150, 0)
	else
		espButton.Text = "ESP: ‡∏õ‡∏¥‡∏î"
		espButton.BackgroundColor3 = Color3.fromRGB(150, 0, 0)
		for _, hl in pairs(highlightList) do
			if hl and hl.Parent then hl:Destroy() end
		end
		highlightList = {}
	end
end)

--// Lock Button
local lockButton = Instance.new("TextButton", menuFrame)
lockButton.Size = UDim2.new(1, -20, 0, 40)
lockButton.Position = UDim2.new(0, 10, 0, 90)
lockButton.Text = "Lock Target: ‡∏õ‡∏¥‡∏î"
lockButton.BackgroundColor3 = Color3.fromRGB(150, 0, 0)
lockButton.TextColor3 = Color3.new(1, 1, 1)
lockButton.TextScaled = true

lockButton.MouseButton1Click:Connect(function()
	lockTargetEnabled = not lockTargetEnabled
	if lockTargetEnabled then
		lockButton.Text = "Lock Target: ‡πÄ‡∏õ‡∏¥‡∏î"
		lockButton.BackgroundColor3 = Color3.fromRGB(0, 150, 0)
	else
		lockButton.Text = "Lock Target: ‡∏õ‡∏¥‡∏î"
		lockButton.BackgroundColor3 = Color3.fromRGB(150, 0, 0)
		currentTarget = nil
	end
end)

--// ‡∏£‡∏∞‡∏¢‡∏∞‡∏•‡πá‡∏≠‡∏Ñ (TextBox)
local rangeBox = Instance.new("TextBox", menuFrame)
rangeBox.Size = UDim2.new(1, -20, 0, 30)
rangeBox.Position = UDim2.new(0, 10, 0, 140)
rangeBox.PlaceholderText = "‡∏£‡∏∞‡∏¢‡∏∞‡∏•‡πá‡∏≠‡∏Ñ (‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: "..lockRange..")"
rangeBox.Text = ""
rangeBox.TextScaled = true
rangeBox.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
rangeBox.TextColor3 = Color3.new(1, 1, 1)

rangeBox.FocusLost:Connect(function()
	local val = tonumber(rangeBox.Text)
	if val then
		lockRange = val
		rangeBox.PlaceholderText = "‡∏£‡∏∞‡∏¢‡∏∞‡∏•‡πá‡∏≠‡∏Ñ (‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: "..lockRange..")"
	end
	rangeBox.Text = ""
end)

--// Highlight ‡∏£‡∏∞‡∏ö‡∏ö
local function highlightPlayer(plr)
	if not plr.Character then return end
	local char = plr.Character
	if highlightList[char] then return end

	local hl = Instance.new("Highlight")
	if player.Team and plr.Team == player.Team then
		hl.FillColor = Color3.fromRGB(0, 255, 0) -- ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß
		hl.OutlineColor = Color3.fromRGB(0, 255, 0)
	else
		hl.FillColor = Color3.fromRGB(255, 0, 0) -- ‡∏®‡∏±‡∏ï‡∏£‡∏π ‡∏™‡∏µ‡πÅ‡∏î‡∏á
		hl.OutlineColor = Color3.fromRGB(255, 0, 0)
	end
	hl.Parent = char
	highlightList[char] = hl
end

--// ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö ESP ‡∏ó‡∏∏‡∏Å 1 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
task.spawn(function()
	while task.wait(1) do
		if not espEnabled then continue end
		for _, plr in pairs(Players:GetPlayers()) do
			if plr ~= player then
				highlightPlayer(plr)
			end
		end
	end
end)

--// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏ä‡πá‡∏Ñ‡∏Å‡∏≤‡∏£‡∏°‡∏≠‡∏á‡πÄ‡∏´‡πá‡∏ô
local function isVisible(targetPart)
	local origin = camera.CFrame.Position
	local direction = (targetPart.Position - origin).Unit * (targetPart.Position - origin).Magnitude
	local raycastParams = RaycastParams.new()
	raycastParams.FilterType = Enum.RaycastFilterType.Blacklist
	raycastParams.FilterDescendantsInstances = {player.Character}
	local result = Workspace:Raycast(origin, direction, raycastParams)
	return not result or (result.Instance and result.Instance:IsDescendantOf(targetPart.Parent))
end

--// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏≤‡∏®‡∏±‡∏ï‡∏£‡∏π‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏™‡∏∏‡∏î
local function getClosestEnemy()
	local nearest = nil
	local shortest = lockRange

	for _, plr in pairs(Players:GetPlayers()) do
		if plr ~= player and plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") and plr.Team ~= player.Team then
			local hrp = plr.Character.HumanoidRootPart
			local pos, onScreen = camera:WorldToViewportPoint(hrp.Position)
			if onScreen and isVisible(hrp) then
				local dist = (hrp.Position - camera.CFrame.Position).Magnitude
				if dist < shortest then
					shortest = dist
					nearest = hrp
				end
			end
		end
	end

	return nearest
end

--// ‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡πá‡∏≠‡∏Ñ‡πÄ‡∏õ‡πâ‡∏≤
RunService.RenderStepped:Connect(function()
	if lockTargetEnabled then
		if not currentTarget or not currentTarget.Parent then
			currentTarget = getClosestEnemy()
		end

		if currentTarget then
			local targetPos = currentTarget.Position
			camera.CFrame = CFrame.new(camera.CFrame.Position, targetPos)
		end
	end
end)
