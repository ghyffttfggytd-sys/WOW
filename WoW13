--// Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local player = Players.LocalPlayer
local camera = workspace.CurrentCamera

--// Settings
local espEnabled = true
local lockEnabled = false
local lockDistance = 100 -- ระยะล็อคเริ่มต้น
local highlightList = {}
local currentTarget = nil

--// GUI
local gui = Instance.new("ScreenGui", player:WaitForChild("PlayerGui"))
gui.ResetOnSpawn = false

-- พื้นที่หลักของเมนู
local menuFrame = Instance.new("Frame", gui)
menuFrame.Size = UDim2.new(0, 200, 0, 180)
menuFrame.Position = UDim2.new(0.05, 0, 0.6, 0)
menuFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
menuFrame.BorderSizePixel = 2
menuFrame.BorderColor3 = Color3.fromRGB(0, 255, 0)
menuFrame.Active = true
menuFrame.Draggable = true

-- ปุ่มพับ/ขยายเมนู
local toggleButton = Instance.new("TextButton", menuFrame)
toggleButton.Size = UDim2.new(1, 0, 0, 30)
toggleButton.Text = "❌ ปิดเมนู"
toggleButton.TextColor3 = Color3.new(1, 1, 1)
toggleButton.BackgroundColor3 = Color3.fromRGB(0, 170, 0)
toggleButton.TextScaled = true

-- กล่องเมนูที่พับได้
local contentFrame = Instance.new("Frame", menuFrame)
contentFrame.Size = UDim2.new(1, 0, 1, -30)
contentFrame.Position = UDim2.new(0, 0, 0, 30)
contentFrame.BackgroundTransparency = 1
contentFrame.ClipsDescendants = true

-- ปุ่มเปิดปิด ESP
local espButton = Instance.new("TextButton", contentFrame)
espButton.Size = UDim2.new(1, -20, 0, 40)
espButton.Position = UDim2.new(0, 10, 0, 10)
espButton.Text = "ESP: เปิด"
espButton.BackgroundColor3 = Color3.fromRGB(0, 150, 0)
espButton.TextColor3 = Color3.new(1, 1, 1)
espButton.TextScaled = true

-- ปุ่มเปิดปิด Lock Target
local lockButton = Instance.new("TextButton", contentFrame)
lockButton.Size = UDim2.new(1, -20, 0, 40)
lockButton.Position = UDim2.new(0, 10, 0, 60)
lockButton.Text = "ล็อคเป้า: ปิด"
lockButton.BackgroundColor3 = Color3.fromRGB(150, 0, 0)
lockButton.TextColor3 = Color3.new(1, 1, 1)
lockButton.TextScaled = true

-- กล่องพิมพ์ระยะล็อคเป้า
local rangeBox = Instance.new("TextBox", contentFrame)
rangeBox.Size = UDim2.new(1, -20, 0, 30)
rangeBox.Position = UDim2.new(0, 10, 0, 110)
rangeBox.PlaceholderText = "ระยะล็อคเป้า (เช่น 100)"
rangeBox.Text = tostring(lockDistance)
rangeBox.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
rangeBox.TextColor3 = Color3.new(1, 1, 1)
rangeBox.TextScaled = true

-- ปุ่มพับเมนู
local menuOpen = true
toggleButton.MouseButton1Click:Connect(function()
	menuOpen = not menuOpen
	if menuOpen then
		contentFrame.Visible = true
		toggleButton.Text = "❌ ปิดเมนู"
	else
		contentFrame.Visible = false
		toggleButton.Text = "✔️ เปิดเมนู"
	end
end)

-- ปุ่ม ESP
espButton.MouseButton1Click:Connect(function()
	espEnabled = not espEnabled
	if espEnabled then
		espButton.Text = "ESP: เปิด"
		espButton.BackgroundColor3 = Color3.fromRGB(0, 150, 0)
	else
		espButton.Text = "ESP: ปิด"
		espButton.BackgroundColor3 = Color3.fromRGB(150, 0, 0)
		for _,hl in pairs(highlightList) do
			if hl and hl.Parent then hl:Destroy() end
		end
		highlightList = {}
	end
end)

-- ปุ่ม Lock Target
lockButton.MouseButton1Click:Connect(function()
	lockEnabled = not lockEnabled
	if lockEnabled then
		lockButton.Text = "ล็อคเป้า: เปิด"
		lockButton.BackgroundColor3 = Color3.fromRGB(0, 150, 0)
	else
		lockButton.Text = "ล็อคเป้า: ปิด"
		lockButton.BackgroundColor3 = Color3.fromRGB(150, 0, 0)
	end
end)

-- เปลี่ยนระยะล็อค
rangeBox.FocusLost:Connect(function()
	local num = tonumber(rangeBox.Text)
	if num and num > 0 then
		lockDistance = num
	else
		rangeBox.Text = tostring(lockDistance)
	end
end)

-- ฟังก์ชันสร้าง ESP
local function createESP(character, color)
	if highlightList[character] then return end
	local hl = Instance.new("Highlight")
	hl.FillColor = color
	hl.OutlineColor = color
	hl.Parent = character
	highlightList[character] = hl
end

-- ลบ ESP ที่หาย
local function cleanupESP()
	for char, hl in pairs(highlightList) do
		if not char or not char.Parent then
			if hl and hl.Parent then hl:Destroy() end
			highlightList[char] = nil
		end
	end
end

-- อัปเดต ESP ทุกๆ 1 วินาที
task.spawn(function()
	while true do
		if espEnabled then
			for _,plr in pairs(Players:GetPlayers()) do
				if plr ~= player and plr.Character then
					local color = Color3.fromRGB(255, 0, 0)
					if plr.Team == player.Team then
						color = Color3.fromRGB(0, 255, 0)
					end
					createESP(plr.Character, color)
				end
			end
			cleanupESP()
		end
		task.wait(1)
	end
end)

-- ฟังก์ชันหาศัตรูที่ใกล้และมองเห็นได้
local function getVisibleEnemy()
	local closest, dist = nil, lockDistance
	for _,plr in pairs(Players:GetPlayers()) do
		if plr ~= player and plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") then
			if plr.Team ~= player.Team then
				local hrp = plr.Character.HumanoidRootPart
				local screenPos, onScreen = camera:WorldToViewportPoint(hrp.Position)
				if onScreen then
					local mag = (hrp.Position - camera.CFrame.Position).Magnitude
					local ray = Ray.new(camera.CFrame.Position, (hrp.Position - camera.CFrame.Position).Unit * mag)
					local part = workspace:FindPartOnRay(ray, player.Character, false, true)
					if part and part:IsDescendantOf(plr.Character) then
						if mag < dist then
							dist = mag
							closest = plr
						end
					end
				end
			end
		end
	end
	return closest
end

-- ล็อคเป้าอัตโนมัติ
RunService.RenderStepped:Connect(function()
	if lockEnabled then
		local target = getVisibleEnemy()
		if target and target.Character and target.Character:FindFirstChild("HumanoidRootPart") then
			currentTarget = target
			camera.CFrame = CFrame.new(camera.CFrame.Position, target.Character.HumanoidRootPart.Position)
		end
	end
end)
