--// Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")

local LocalPlayer = Players.LocalPlayer

--// Settings
local espEnabled = true -- เปิด/ปิด ESP
local enemyColor = Color3.fromRGB(255,0,0) -- สีศัตรู

--// GUI
local ScreenGui = Instance.new("ScreenGui", LocalPlayer:WaitForChild("PlayerGui"))
ScreenGui.ResetOnSpawn = false

--// Main Frame
local Frame = Instance.new("Frame")
Frame.Size = UDim2.new(0, 180, 0, 70)
Frame.Position = UDim2.new(0, 20, 0, 20)
Frame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
Frame.BorderSizePixel = 0
Frame.Active = true
Frame.Draggable = true
Frame.Parent = ScreenGui

local FrameCorner = Instance.new("UICorner")
FrameCorner.CornerRadius = UDim.new(0, 15)
FrameCorner.Parent = Frame

--// Toggle ESP Button
local ToggleButton = Instance.new("TextButton")
ToggleButton.Size = UDim2.new(1, -10, 0.6, -10)
ToggleButton.Position = UDim2.new(0, 5, 0, 5)
ToggleButton.BackgroundColor3 = Color3.fromRGB(255, 0, 0)
ToggleButton.BorderSizePixel = 0
ToggleButton.TextColor3 = Color3.fromRGB(255, 255, 255)
ToggleButton.Text = "ESP: ON"
ToggleButton.Font = Enum.Font.SourceSansBold
ToggleButton.TextScaled = true
ToggleButton.Parent = Frame

local ButtonCorner = Instance.new("UICorner")
ButtonCorner.CornerRadius = UDim.new(0, 12)
ButtonCorner.Parent = ToggleButton

--// Expand/Collapse Button
local ExpandButton = Instance.new("TextButton")
ExpandButton.Size = UDim2.new(0, 30, 0, 30)
ExpandButton.Position = UDim2.new(1, -35, 1, -35)
ExpandButton.BackgroundColor3 = Color3.fromRGB(100, 100, 100)
ExpandButton.Text = "+"
ExpandButton.Font = Enum.Font.SourceSansBold
ExpandButton.TextScaled = true
ExpandButton.TextColor3 = Color3.fromRGB(255, 255, 255)
ExpandButton.Parent = Frame

local ExpandCorner = Instance.new("UICorner")
ExpandCorner.CornerRadius = UDim.new(0, 10)
ExpandCorner.Parent = ExpandButton

local expanded = true
ExpandButton.MouseButton1Click:Connect(function()
    expanded = not expanded
    local goal = {}
    if expanded then
        goal.Size = UDim2.new(0, 180, 0, 70)
    else
        goal.Size = UDim2.new(0, 50, 0, 50)
    end
    TweenService:Create(Frame, TweenInfo.new(0.3), goal):Play()
end)

--// Function to update button color (glow effect)
local function updateButtonColor()
    if espEnabled then
        local hue = tick()%5 / 5
        local color = Color3.fromHSV(hue,1,1)
        ToggleButton.BackgroundColor3 = color
    else
        ToggleButton.BackgroundColor3 = Color3.fromRGB(100, 100, 100)
    end
end

--// Toggle ESP
ToggleButton.MouseButton1Click:Connect(function()
    espEnabled = not espEnabled
    ToggleButton.Text = espEnabled and "ESP: ON" or "ESP: OFF"
    updateButtonColor()
    
    if not espEnabled then
        for _, player in pairs(Players:GetPlayers()) do
            if player.Character and player.Character:FindFirstChild("ESPHighlight") then
                player.Character.ESPHighlight:Destroy()
            end
        end
    end
end)

--// Update button color continuously
RunService.RenderStepped:Connect(updateButtonColor)

--// ฟังก์ชันสร้าง Highlight
local function createESP(player)
    if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
        if not player.Character:FindFirstChild("ESPHighlight") then
            local highlight = Instance.new("Highlight")
            highlight.Name = "ESPHighlight"
            highlight.Adornee = player.Character
            highlight.FillColor = enemyColor
            highlight.OutlineColor = Color3.fromRGB(0,0,0)
            highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
            highlight.Parent = player.Character
        end
    end
end

-- ฟังก์ชันลบ Highlight
local function removeESP(player)
    if player.Character and player.Character:FindFirstChild("ESPHighlight") then
        player.Character.ESPHighlight:Destroy()
    end
end

--// ตรวจสอบผู้เล่นทุกเฟรม
RunService.RenderStepped:Connect(function()
    if not espEnabled then return end

    for _, player in pairs(Players:GetPlayers()) do
        if player ~= LocalPlayer then
            if player.TeamColor == BrickColor.new("Bright red") then
                createESP(player)
            else
                removeESP(player)
            end
        end
    end
end)

--// ตรวจจับผู้เล่นใหม่เข้าร่วมเกม
Players.PlayerAdded:Connect(function(player)
    player.CharacterAdded:Connect(function()
        if player.TeamColor == BrickColor.new("Bright red") then
            createESP(player)
        end
    end)
end)
