--// Services
local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")

local LocalPlayer = Players.LocalPlayer

--// Settings
local espEnabled = false
local teamColorEnabled = true
local highlightList = {}

--// ฟังก์ชันสร้าง ESP
local function createESP(player)
    -- ลบ Highlight เก่าก่อน
    if highlightList[player] then
        highlightList[player]:Destroy()
        highlightList[player] = nil
    end

    if not player.Character then return end

    local highlight = Instance.new("Highlight")
    highlight.Adornee = player.Character
    highlight.FillTransparency = 0.5
    highlight.OutlineTransparency = 0
    highlight.Parent = workspace

    -- สีตามทีม
    if teamColorEnabled then
        if player.Team == LocalPlayer.Team then
            highlight.FillColor = Color3.fromRGB(0,255,0) -- เพื่อน
        else
            highlight.FillColor = Color3.fromRGB(255,0,0) -- ศัตรู
        end
    else
        highlight.FillColor = Color3.fromRGB(255,0,0)
    end

    highlightList[player] = highlight
end

--// ฟังก์ชันลบ ESP
local function removeESP(player)
    if highlightList[player] then
        highlightList[player]:Destroy()
        highlightList[player] = nil
    end
end

--// ตรวจจับผู้เล่นและ spawn ใหม่
local function setupPlayer(player)
    player.CharacterAdded:Connect(function(character)
        if espEnabled then
            createESP(player)
        end
    end)

    -- ถ้ามี Character อยู่แล้ว ให้สร้าง ESP
    if player.Character then
        if espEnabled then
            createESP(player)
        end
    end
end

--// ตั้งค่า ESP สำหรับผู้เล่นทั้งหมด
for _, player in pairs(Players:GetPlayers()) do
    if player ~= LocalPlayer then
        setupPlayer(player)
    end
end

--// ตรวจจับผู้เล่นใหม่เข้ามาในเกม
Players.PlayerAdded:Connect(function(player)
    if player ~= LocalPlayer then
        setupPlayer(player)
    end
end)

--// อัพเดทสี ESP ทุก 0.5 วินาที
spawn(function()
    while true do
        if espEnabled then
            for player, highlight in pairs(highlightList) do
                if player.Character and teamColorEnabled then
                    if player.Team == LocalPlayer.Team then
                        highlight.FillColor = Color3.fromRGB(0,255,0)
                    else
                        highlight.FillColor = Color3.fromRGB(255,0,0)
                    end
                end
            end
        end
        wait(0.5)
    end
end)

--// GUI มือถือ (ปุ่มเปิด/ปิด ESP)
local screenGui = Instance.new("ScreenGui")
screenGui.ResetOnSpawn = false
screenGui.Parent = LocalPlayer:WaitForChild("PlayerGui")

local toggleButton = Instance.new("TextButton")
toggleButton.Size = UDim2.new(0,120,0,50)
toggleButton.Position = UDim2.new(0,20,0,20)
toggleButton.BackgroundColor3 = Color3.fromRGB(50,50,50)
toggleButton.TextColor3 = Color3.fromRGB(255,255,255)
toggleButton.Text = "ESP: OFF"
toggleButton.Parent = screenGui
toggleButton.AutoButtonColor = true
toggleButton.TextScaled = true

toggleButton.MouseButton1Click:Connect(function()
    espEnabled = not espEnabled
    toggleButton.Text = espEnabled and "ESP: ON" or "ESP: OFF"

    if espEnabled then
        for _, player in pairs(Players:GetPlayers()) do
            if player ~= LocalPlayer then
                createESP(player)
            end
        end
    else
        for player, _ in pairs(highlightList) do
            removeESP(player)
        end
    end
end)
