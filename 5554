--// Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")

local LocalPlayer = Players.LocalPlayer

--// Settings
local espEnabled = false
local teamColorEnabled = true
local highlightList = {}
local maxDistance = 200

--// ฟังก์ชันสร้าง Highlight ติดตัวผู้เล่นตลอด
local function createESP(player)
    if highlightList[player] then
        highlightList[player]:Destroy()
        highlightList[player] = nil
    end

    local highlight = Instance.new("Highlight")
    highlight.FillTransparency = 0.5
    highlight.OutlineTransparency = 0
    highlight.OutlineColor = Color3.fromRGB(255,255,255)
    highlight.OutlineThickness = 2
    highlight.Parent = Workspace
    highlight.Name = player.Name .. "_ESP"

    highlightList[player] = highlight

    local function updateAdornee()
        if player.Character then
            highlight.Adornee = player.Character
            if teamColorEnabled then
                if player.Team == LocalPlayer.Team then
                    highlight.FillColor = Color3.fromRGB(0,255,0)
                else
                    highlight.FillColor = Color3.fromRGB(255,0,0)
                end
            else
                highlight.FillColor = Color3.fromRGB(255,0,0)
            end
        else
            highlight.Adornee = nil
        end
    end

    updateAdornee()
    player.CharacterAdded:Connect(updateAdornee)
    player:GetPropertyChangedSignal("Team"):Connect(updateAdornee)
end

--// ฟังก์ชันลบ ESP
local function removeESP(player)
    if highlightList[player] then
        highlightList[player]:Destroy()
        highlightList[player] = nil
    end
end

--// ตั้งค่า ESP สำหรับผู้เล่น
local function setupPlayer(player)
    createESP(player)
end

--// สร้าง ESP สำหรับผู้เล่นทั้งหมดที่มีอยู่แล้ว
for _, player in pairs(Players:GetPlayers()) do
    if player ~= LocalPlayer then
        setupPlayer(player)
    end
end

--// ตรวจจับผู้เล่นใหม่เข้ามาในเกม
Players.PlayerAdded:Connect(function(player)
    if player ~= LocalPlayer then
        setupPlayer(player)
    end
end)

--// ปรับ FillTransparency และ OutlineThickness ตามระยะทุกเฟรม
RunService.RenderStepped:Connect(function()
    if espEnabled then
        local localRoot = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
        if not localRoot then return end
        for player, highlight in pairs(highlightList) do
            if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
                local distance = (localRoot.Position - player.Character.HumanoidRootPart.Position).Magnitude
                highlight.FillTransparency = math.clamp(distance / maxDistance, 0.2, 0.8)
                highlight.OutlineThickness = math.clamp(5 - (distance / maxDistance * 4), 1, 5)
            end
        end
    end
end)

--// GUI มือถือ: พับ/กาง + ลากได้ + ปุ่มเปิด/ปิด ESP
local screenGui = Instance.new("ScreenGui")
screenGui.ResetOnSpawn = false
screenGui.Parent = LocalPlayer:WaitForChild("PlayerGui")

local mainFrame = Instance.new("Frame")
mainFrame.Size = UDim2.new(0,150,0,50)
mainFrame.Position = UDim2.new(0,20,0,20)
mainFrame.BackgroundColor3 = Color3.fromRGB(50,50,50)
mainFrame.BorderSizePixel = 0
mainFrame.Active = true
mainFrame.Draggable = true
mainFrame.Parent = screenGui

-- ปุ่มพับ/กาง
local foldButton = Instance.new("TextButton")
foldButton.Size = UDim2.new(0,30,0,30)
foldButton.Position = UDim2.new(1,-35,0,10)
foldButton.BackgroundColor3 = Color3.fromRGB(100,100,100)
foldButton.Text = "▲"
foldButton.TextScaled = true
foldButton.Parent = mainFrame

-- ปุ่มเปิด/ปิด ESP
local toggleButton = Instance.new("TextButton")
toggleButton.Size = UDim2.new(1, -45, 1, 0)
toggleButton.Position = UDim2.new(0,5,0,0)
toggleButton.BackgroundColor3 = Color3.fromRGB(70,70,70)
toggleButton.TextColor3 = Color3.fromRGB(255,255,255)
toggleButton.Text = "ESP: OFF"
toggleButton.TextScaled = true
toggleButton.Parent = mainFrame

-- ฟังก์ชันพับ/กาง
local folded = false
foldButton.MouseButton1Click:Connect(function()
    folded = not folded
    if folded then
        mainFrame.Size = UDim2.new(0,50,0,50)
        toggleButton.Visible = false
        foldButton.Text = "▼"
    else
        mainFrame.Size = UDim2.new(0,150,0,50)
        toggleButton.Visible = true
        foldButton.Text = "▲"
    end
end)

-- ฟังก์ชันเปิด/ปิด ESP
toggleButton.MouseButton1Click:Connect(function()
    espEnabled = not espEnabled
    toggleButton.Text = espEnabled and "ESP: ON" or "ESP: OFF"

    if espEnabled then
        for _, player in pairs(Players:GetPlayers()) do
            if player ~= LocalPlayer then
                setupPlayer(player)
            end
        end
    else
        for player, _ in pairs(highlightList) do
            removeESP(player)
        end
    end
end)
