--// Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")

local player = Players.LocalPlayer
local camera = workspace.CurrentCamera

--// Settings
local espEnabled = true
local highlightList = {}

--// GUI
local screenGui = Instance.new("ScreenGui")
screenGui.Parent = player:WaitForChild("PlayerGui")

-- Draggable UI Frame
local mainFrame = Instance.new("Frame")
mainFrame.Size = UDim2.new(0, 150, 0, 50)
mainFrame.Position = UDim2.new(0.05, 0, 0.05, 0)
mainFrame.BackgroundColor3 = Color3.fromRGB(30,30,30)
mainFrame.BorderSizePixel = 0
mainFrame.Active = true
mainFrame.Draggable = true
mainFrame.Parent = screenGui

local toggleButton = Instance.new("TextButton")
toggleButton.Size = UDim2.new(1, 0, 1, 0)
toggleButton.Text = "ESP: ✔️"
toggleButton.TextColor3 = Color3.fromRGB(255,255,255)
toggleButton.BackgroundColor3 = Color3.fromRGB(50,50,50)
toggleButton.Parent = mainFrame

-- Toggle ESP
toggleButton.MouseButton1Click:Connect(function()
    espEnabled = not espEnabled
    toggleButton.Text = espEnabled and "ESP: ✔️" or "ESP: ❌"
    -- Hide highlights if disabled
    if not espEnabled then
        for _, hl in pairs(highlightList) do
            hl.Enabled = false
        end
    else
        for _, hl in pairs(highlightList) do
            hl.Enabled = true
        end
    end
end)

--// ESP Function
local function createESP(character)
    if highlightList[character] then return end
    local highlight = Instance.new("Highlight")
    highlight.Adornee = character
    highlight.FillTransparency = 0.5
    highlight.OutlineTransparency = 0
    highlight.OutlineColor = Color3.new(1,1,1)
    
    -- Determine team color
    if character:FindFirstChild("Humanoid") then
        if character.Parent == player.Team then
            highlight.FillColor = Color3.fromRGB(0,255,0) -- เพื่อน สีเขียว
        else
            highlight.FillColor = Color3.fromRGB(255,0,0) -- ศัตรู สีแดง
        end
    end
    highlight.Parent = screenGui
    highlightList[character] = highlight
end

-- Remove ESP if player leaves
Players.PlayerRemoving:Connect(function(p)
    if p.Character and highlightList[p.Character] then
        highlightList[p.Character]:Destroy()
        highlightList[p.Character] = nil
    end
end)

-- Track new characters
Players.PlayerAdded:Connect(function(p)
    p.CharacterAdded:Connect(function(c)
        createESP(c)
    end)
end)

-- Initialize ESP for existing players
for _, p in pairs(Players:GetPlayers()) do
    if p ~= player then
        if p.Character then
            createESP(p.Character)
        end
        p.CharacterAdded:Connect(function(c)
            createESP(c)
        end)
    end
end

-- Update loop
RunService.RenderStepped:Connect(function()
    if not espEnabled then return end
    for char, hl in pairs(highlightList) do
        if char.Parent and char:FindFirstChild("Humanoid") then
            -- Update color dynamically if team changes
            if char.Parent == player.Team then
                hl.FillColor = Color3.fromRGB(0,255,0)
            else
                hl.FillColor = Color3.fromRGB(255,0,0)
            end
        end
    end
end)
